name: Deploy to Kubernetes

on:
  push:
    branches:
      - staging
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Google Cloud SDK
      uses: GoogleCloudPlatform/github-actions/setup-gcloud@main
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}

    - name: Configure gcloud CLI
      run: |
        gcloud auth configure-docker
        gcloud config set project your-project-id
        gcloud container clusters get-credentials your-cluster-name --region your-region

    - name: Deploy to Kubernetes
      run: |
        if [[ $GITHUB_REF == "refs/heads/staging" ]]; then
          kubectl apply -f k8s/staging.yaml
        elif [[ $GITHUB_REF == "refs/heads/prod" ]]; then
          kubectl apply -f k8s/prod.yaml
        fi
